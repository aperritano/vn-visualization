<!DOCTYPE html>
<meta charset="utf-8">
<head>

    <script src="./bower_components/d3/d3.js"></script>
    <script src="./bower_components/topojson/topojson.js"></script>
    <script src="./bower_components/moment/moment.js"></script>
    <script src="./bower_components/firebase/firebase.js"></script>

    <script src="./node_components/predicate.js"></script>

    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="./slider/d3.slider.js"></script>
    <link rel="stylesheet" href="./slider/d3.slider.css"/>

    <style>

        body {
            font: 12px sans-serif;
        }

        path {
            stroke-width: .5px;
            stroke: white;
            fill: #9E9E9E;
            cursor: pointer;
        }

        path:hover, path.highlighted {
            fill: tomato;
        }

        div.tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid black;
            color: black;
            font-weight: bold;
            padding: 4px 8px;
            display: none;
        }

        .bubble {
            fill-opacity: .5;
        }

        .bubble :hover {
            stroke: #000;
        }

        .wrapper {
            margin-left: auto;
            margin-right: auto;
        }

        .timeBox {
            margin-top: 30px;
        }

        .area {
            fill: steelblue;
            clip-path: url(#clip);
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .brush .extent {
            stroke: #fff;
            fill-opacity: .125;
            shape-rendering: crispEdges;
        }


    </style>

</head>
<body>

    <div id="container"></div>
    <div id="slider"></div>
    <div>
        <h2>
            <span id="sliderText">0</span>
        </h2>
    </div>

    <script>

        /**
         * Call the function to get the data.
         */
        getData();

        /**
         * Initialize the visualization.
         */
        initViz();



        /*#########################################################################
         *              FUNCTION USED TO RETRIEVE THE DATA
         *#########################################################################*/
        function getData(){

            var fbase = new Firebase('https://visualizingnetworks.firebaseio.com/timestamps');

            // Retrieving data from the DB
            fbase.on("value", function (snapshot) {

                createSlider(snapshot.val());

            }, function (errorObject) {
                console.log("The read failed: " + errorObject.code);
            });

        }

        /*#########################################################################
         *              FUNCTION USED TO INITIALIZE THE VISUALIZATION
         *#########################################################################*/
        function initViz() {

            /**********************
             * Map creation.
             *********************/

            var width = window.innerWidth;
            var height = window.innerHeight - 100;

            colors = ['#00000', '#d32f2f', '#1976D2'];
            //Map projection
            projection = d3.geo.mercator()
                    .scale(10000)
                    .center([36.922895, 0.3508943]) //projection center
                    .translate([width / 2, height / 2]) //translate to center the map in view

            //Generate paths based on projection
            path = d3.geo.path()
                    .projection(projection);

            //Create an SVG
            svg = d3.select("#container").append("svg")
                    .attr("width", width)
                    .attr("height", height);

            //Group for the map features
            features = svg.append("g")
                    .attr("class", "features");

            //Create zoom/pan listener
            //Change [1,Infinity] to adjust the min/max zoom scale
            zoom = d3.behavior.zoom()
                    .scaleExtent([1, Infinity])
                    .on("zoom", zoomed);

            svg.call(zoom);

            //Create a tooltip, hidden at the start
            tooltip = d3.select("body").append("div").attr("class", "tooltip");

            d3.json("kenya.topojson", function (error, geodata) {
                if (error) return console.log(error); //unknown error, check the console

                //Create a path for each map feature in the data
                features.selectAll("path")
                        .append('g')
                        .data(topojson.feature(geodata, geodata.objects.KEN).features) //generate features from TopoJSON
                        .enter()
                        .append("path")
                        .attr("d", path)
                        .on("mouseover", showTooltip)
                        .on("mousemove", moveTooltip)
                        .on("mouseout", hideTooltip)
                        .on("click", clicked);
            });

        }

        // Add optional onClick events for features here
        // d.properties contains the attributes (e.g. d.properties.name, d.properties.population)
        function clicked(d, i) {

        }

        //Update map on zoom/pan
        function zoomed() {
            features.attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")")
                    .selectAll("path").style("stroke-width", 1 / zoom.scale() + "px");
        }

        //Position of the tooltip relative to the cursor
        var tooltipOffset = {x: 5, y: -25};

        //Create a tooltip, hidden at the start
        function showTooltip(d) {
            moveTooltip();

            tooltip.style("display", "block")
                    .text(d.properties.ID);
        }

        //Move the tooltip to track the mouse
        function moveTooltip() {
            tooltip.style("top", (d3.event.pageY + tooltipOffset.y) + "px")
                    .style("left", (d3.event.pageX + tooltipOffset.x) + "px");
        }

        //Create a tooltip, hidden at the start
        function hideTooltip() {
            tooltip.style("display", "none");
        }

        /*#########################################################################
         *              FUNCTION USED TO CREATE THE SLIDER
         *#########################################################################*/
        function createSlider(dataset) {

            /**********************
             * Slider creation.
             *********************/

            min = dataset[0].millisec;
            max = dataset[dataset.length - 1].millisec;

            console.log(min);
            console.log(max);

            slider = d3.slider().min(min).max(max).axis(true).step(60);
            slider.on("slide", function(evt, value) {

                d3.select('#sliderText').text(value);

                // Update the position of the points of this timestamp
                selectedItem = value - min;
                updatePointPosition(selectedItem, dataset);

            });

            d3.select('#slider').call(slider);

        }

        /*#########################################################################
         *              FUNCTION USED TO UPDATE THE POINTS POSITION
         *#########################################################################*/

        function updatePointPosition(selectedItem, datasets) {

            item = datasets[selectedItem];

            circles = svg.selectAll('circle');
            circles.remove();
            if (item.items.length > 0) {
                svg.selectAll('circle').data(item.items).enter()
                        .append("circle")
                        .attr("r", '10px')
                        .attr("cx", function(d) { return projection([d.lon, d.lat])[0]; } )
                        .attr("cy", function(d) { return projection([d.lon, d.lat])[1]; } );
            }
        }

    </script>

</body>
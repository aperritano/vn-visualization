<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <script src="../bower_components/d3/d3.js"></script>
    <script src="../bower_components/topojson/topojson.js"></script>
    <script src="../bower_components/moment/moment.js"></script>
    <script src="../node_modules/predicate/dist/predicate.js"></script>
    <script src="./slider/d3.slider.js"></script>
    <script src="../bower_components/firebase/firebase.js"></script>

    <link rel="stylesheet" href="./slider/d3.slider.css"/>


    <style>

        body {
            font: 12px sans-serif;
        }

        path {
            stroke-width: .5px;
            stroke: white;
            fill: #9E9E9E;
            cursor: pointer;
        }

        path:hover, path.highlighted {
            fill: tomato;
        }

        div.tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid black;
            color: black;
            font-weight: bold;
            padding: 4px 8px;
            display: none;
        }

        .bubble {
            fill-opacity: .5;
        }

        .bubble :hover {
            stroke: #000;
        }

        .wrapper {
            margin-left: auto;
            margin-right: auto;
        }

        .timeBox {
            margin-top: 30px;
        }

        .area {
            fill: steelblue;
            clip-path: url(#clip);
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .brush .extent {
            stroke: #fff;
            fill-opacity: .125;
            shape-rendering: crispEdges;
        }

        .axis text {
            font: 10px sans-serif;
        }

        .axis line,
        .axis path {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }


    </style>
</head>
<body>
<div id="timeliner"></div>
<div id="container"></div>
<div class="wrapper">
    <div id="timelineSlider"></div>
</div>
<!--<div class="timeBox"><span id="sliderValue">0</span></div>-->


<script>

    var fbase = new Firebase('https://visualizingnetworks.firebaseio.com/timestamps');
    var tooltip;
    var svg;
    var colors;
    var projection;
    var path;
    var features;
    var zoom;

    initViz();

    fbase.on("value", function (snapshot) {
        //console.log(JSON.stringify(snapshot.val()));
        updateViz(snapshot.val());
    }, function (errorObject) {
        console.log("The read failed: " + errorObject.code);
    });


    function initViz() {

        var width = window.innerWidth;
        var height = window.innerHeight - 100;

        colors = ['#00000', '#d32f2f', '#1976D2'];
        //Map projection
        projection = d3.geo.mercator()
                .scale(10000)
                .center([36.922895, 0.3508943]) //projection center
                .translate([width / 2, height / 2]) //translate to center the map in view

        //Generate paths based on projection
        path = d3.geo.path()
                .projection(projection);

        //Create an SVG
        svg = d3.select("#container").append("svg")
                .attr("width", width)
                .attr("height", height);

        //Group for the map features
        features = svg.append("g")
                .attr("class", "features");

        //Create zoom/pan listener
        //Change [1,Infinity] to adjust the min/max zoom scale
        zoom = d3.behavior.zoom()
                .scaleExtent([1, Infinity])
                .on("zoom", zoomed);

        svg.call(zoom);

        //Create a tooltip, hidden at the start
        tooltip = d3.select("body").append("div").attr("class", "tooltip");

        var sortTimestamp = [];

        var dataset;

//        d3.json("KEN.topojson", function (error, geodata) {
//            if (error) return console.log(error); //unknown error, check the console
//
//            //Create a path for each map feature in the data
//            features.selectAll("path")
//                    .append('g')
//                    .data(topojson.feature(geodata, geodata.objects.KEN).features) //generate features from TopoJSON
//                    .enter()
//                    .append("path")
//                    .attr("d", path)
//                    .on("mouseover", showTooltip)
//                    .on("mousemove", moveTooltip)
//                    .on("mouseout", hideTooltip)
//                    .on("click", clicked);
//        });

    }




    var dataset = [];

    function createTimeLine(items) {



        var margin = {top: 100, right: 100, bottom: 100, left: 100};
        var width = window.innerWidth - margin.left - margin.right;
        var height = window.innerHeight - margin.top - margin.bottom;

        var x = d3.time.scale()
                .domain([new Date, new Date])
                .nice(d3.time.week)
                .range([0, width]);

        var svg = d3.select("body").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        svg.append("g")
                .attr("class", "x axis")
                .call(d3.svg.axis().scale(x).orient("bottom"));

//        var margin = {top: 40, right: 40, bottom: 40, left:40},
//                width = 600,
//                height = 500;
//
//            var width = window.innerWidth;
//
//            var timeDomain = d3.extent(items, function(d) { return d.timestamp; });
//
//
//            var timeScale = d3.time.scale.utc().range([0, width]).domain(timeDomain).clamp(true);
//
//            d3.select("#timeliner").append("svg")
//                .attr("width", width)
//                .attr("height", 10)
//                .append("g")
//                .call(timeScale);




// axis/scale domain is set [0ms, 8hrs]
// which should appear in the axis as:
// [1/1/1970 12:00am, 1/1/1970 8:00am]

//    “%a - abbreviated weekday name.
//        %A - full weekday name.
//        %b - abbreviated month name.
//        %B - full month name.
//        %c - date and time, as “%a %b %e %H:%M:%S %Y”.
//    %d - zero-padded day of the month as a decimal number [01,31].
//        %e - space-padded day of the month as a decimal number [ 1,31].
//        %H - hour (24-hour clock) as a decimal number [00,23].
//        %I - hour (12-hour clock) as a decimal number [01,12].
//        %j - day of the year as a decimal number [001,366].
//        %m - month as a decimal number [01,12].
//        %M - minute as a decimal number [00,59].
//        %p - either AM or PM.
//        %S - second as a decimal number [00,61]”

//
            //var dayNameFormat = d3.time.utc.format("%A");
        //example: 2009-10-01 12:00:00.000

        //var timeStamper = d3.time.format("%Y-%m-%d %H:%M:%S.%L").parse;

//        var tl = d3.select("#timeliner").append("svg")
//                .attr("width", width + margin.left + margin.right)
//                .attr("height", height + margin.top + margin.bottom)
//                .append("g")
//                .call(xTicks);

//        tl.append("g")
//                .attr("class", "x axis")
//                .attr("transform", "translate(0," + height + ")")
//                .call(xAxis);var tl = d3.select("#timeliner").append("svg")
//                .attr("width", width + margin.left + margin.right)
//                .attr("height", height + margin.top + margin.bottom)
//                .append("g")
//                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
//
//        tl.append("g")
//                .attr("class", "x axis")
//                .attr("transform", "translate(0," + height + ")")
//                .call(xTicks);
    }

    function updateViz(items) {

        var dataset = items;
        createTimeLine(dataset);

//           var firstTS = dataset[0].timestamp;
//            var fm = moment().utc(firstTS).toDate();
//
//            var lastTS = dataset[dataset.length - 1].timestamp;
//            var lm = moment().utc(lastTS).toDate();
//
//        var customTimeFormat = d3.time.format.utc.multi([
//            [".%L", function(d) { return d.getMilliseconds(); }],
//            [":%S", function(d) { return d.getSeconds(); }],
//            ["%I:%M", function(d) { return d.getMinutes(); }],
//            ["%I %p", function(d) { return d.getHours(); }],
//            ["%a %d", function(d) { return d.getDay() && d.getDate() != 1; }],
//            ["%b %d", function(d) { return d.getDate() != 1; }],
//            ["%B", function(d) { return d.getMonth(); }],
//            ["%Y", function() { return true; }]
//        ]);

//        var firstTLDate = customTimeFormat(fm);

//        var margin = {top: 250, right: 40, bottom: 250, left: 40},
//                width = 960 - margin.left - margin.right,
//                height = 500 - margin.top - margin.bottom;
//
//        var x = d3.time.scale().utc().domain([new Date('2014-03-08T12:00:00.000Z'), new Date('2014-03-10T00:00:00.000Z')])
//                .range([0, width]);
//
//        var xAxis = d3.svg.axis()
//                .scale(x)
//                .orient('bottom')
//                .ticks(d3.time.hours.utc, 1)
//                .tickFormat(d3.time.format('%I %p'));
//
//        console.log(xAxis);


//        var tl = d3.select("#timeliner").append("svg")
//                .attr("width", width + margin.left + margin.right)
//                .attr("height", height + margin.top + margin.bottom)
//                .append("g")
//                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
//
//        tl.append("g")
//                .attr("class", "x axis")
//                .attr("transform", "translate(0," + height + ")")
//                .call(xAxis);var tl = d3.select("#timeliner").append("svg")
//                .attr("width", width + margin.left + margin.right)
//                .attr("height", height + margin.top + margin.bottom)
//                .append("g")
//                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
//
//        tl.append("g")
//                .attr("class", "x axis")
//                .attr("transform", "translate(0," + height + ")")
//                .call(xAxis);
//
//            var format = 'YYYY-MM-DD HH:mm:ss';

//            items.forEach(function(entry) {
//
//                var m = moment(entry.timestamp,format).utc();
//                m.valueOf();
//                dataset.push({ 'timestamp': m.valueOf(), items: entry.items});
//            });



        //        example: 2009-10-01 12:00:00.000
        //format: yyyy-MM-dd HH:mm:ss.sss
        //units: UTC (Coordinated Universal Time) or GPS time, which is a few leap seconds different from UTC






//            dataset = items;
//
//            var firstTS = dataset[0].timestamp;
//            var fm = moment().utc(firstTS);
//
//            var lastTS = dataset[dataset.length - 1].timestamp;
//            var lm = moment().utc(lastTS);
//
////        var timeFormat = d3.time.format('%Y-%m-%d T%H:%M:%S');
//
//
//        d3.select('#timelineSlider').call(d3.slider().scale(d3.time.scale().utc().domain([timeFormat.parse(firstTS), timeFormat.parse(lastTS)])).axis(d3.svg.axis()).step(10000).on("slide", function (evt, value) {
//            d3.select('#sliderValue').text(value);
//           // updatePointPosition(value);
//        }));


//            var t1 = dataset[0].items;
//
//            svg.selectAll('circle').data(t1).enter()
//                    .append("circle")
//                    .attr("id", function (d) {
//                        return d.id;
//                    })
//                    .attr("r", "10px")
//                    .attr("fill", function (d) {
//                        var c = colors[parseInt(d.id)];
//                        //console.log('color', c);
//                        return c;
//                    })
////                    .attr("cx", function (d) {
////                        return projection([d.long, d.lat])[0];
////                    })
////                    .attr("cy", function (d) {
////                        return projection([d.long, d.lat])[1];
////                    })
//                    .attr('transform', function (d) {
//                        // console.log('transform', d.lat, d.long);
//                        return 'translate(' + projection([d.lon, d.lat]) + ')'; //plus sign converts to ints
//                    });

    }

    function updatePointPosition(selectedTimestamp) {
        var currentlySelectedTime = selectedTimestamp;
        console.log('selected timestamp', selectedTimestamp);
        var circles = svg.selectAll('circle');

        var results = dataset.filter(function (entry) {
            return entry.timestamp === selectedTimestamp;
        });

        circles.remove();
        if (results.length > 0) {
            svg.selectAll('circle').data(results[0].items).enter()
                    .append("circle")
                    .attr("r", function (d) {
                        return '10px';
                    })
                    .attr("fill", function (d) {
                        var c = colors[parseInt(d.id)];
                        //console.log('color', c);
                        return c;
                    })
//                    .attr("cx", function (d) {
//                        return projection([d.long, d.lat])[0];
//                    })
//                    .attr("cy", function (d) {
//                        return projection([d.long, d.lat])[1];
//                    })
                    .attr('transform', function (d) {
                        // console.log('transform', d.lat, d.long);
                        return 'translate(' + projection([d.lon, d.lat]) + ')'; //plus sign converts to ints
                    });
            console.log('slider update', JSON.stringify(results));
        }
    }


    // Add optional onClick events for features here
    // d.properties contains the attributes (e.g. d.properties.name, d.properties.population)
    function clicked(d, i) {

    }


    //Update map on zoom/pan
    function zoomed() {
        features.attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")")
                .selectAll("path").style("stroke-width", 1 / zoom.scale() + "px");
    }


    //Position of the tooltip relative to the cursor
    var tooltipOffset = {x: 5, y: -25};

    //Create a tooltip, hidden at the start
    function showTooltip(d) {
        moveTooltip();

        tooltip.style("display", "block")
                .text(d.properties.ID);
    }

    //Move the tooltip to track the mouse
    function moveTooltip() {
        tooltip.style("top", (d3.event.pageY + tooltipOffset.y) + "px")
                .style("left", (d3.event.pageX + tooltipOffset.x) + "px");
    }

    //Create a tooltip, hidden at the start
    function hideTooltip() {
        tooltip.style("display", "none");
    }
</script>